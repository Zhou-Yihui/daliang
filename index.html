<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<title>å¤§å‡‰è¯­è¾“å…¥æ³•å®‰å…¨ç‰ˆ</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<style>
:root{--theme:#7c4dff;--bg:#121212;--key:#1e1e1e;--text:#fff;--border:rgba(255,255,255,.15)}
*{box-sizing:border-box;font-family:Roboto,Helvetica Neue,PingFang SC}
body{margin:0;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;/* é˜²æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨å¯¼è‡´é®æŒ¡ */}
header{height:48px;background:var(--theme);display:flex;align-items:center;padding:0 12px;font-weight:bold;z-index:10;/* ç¡®ä¿æ ‡é¢˜æ ä¸è¢«è¦†ç›– */}
main{flex:1;display:flex;flex-direction:column;overflow:hidden;/* ä¸»åŒºåŸŸä¸æ»šåŠ¨ */}
#screen{flex:1;padding:12px;font-size:24px;background:#000;border:1px solid var(--border);overflow-y:auto;white-space:pre-wrap;word-break:break-all;min-height:80px;/* ç¡®ä¿è¾“å…¥æ¡†æœ‰åŸºç¡€é«˜åº¦ */}
#toolbar{height:42px;display:flex;align-items:center;padding:0 8px;border-bottom:1px solid var(--border);z-index:5;}
#toolbar button{margin-left:auto;height:32px;border:none;border-radius:4px;background:var(--theme);color:#fff;padding:0 12px;cursor:pointer;}
#candidate{height:46px;display:flex;align-items:center;padding:0 8px;border-bottom:1px solid var(--border);overflow-x:auto;z-index:5;}
.cand-char{height:36px;margin:0 4px;border:1px solid var(--border);border-radius:4px;background:var(--key);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;}
.cand-char img{height:32px;width:auto;pointer-events:none;}
/* ä¿®å¤ï¼šé”®ç›˜å®¹å™¨ç¡®ä¿æ˜¾ç¤ºï¼Œå›ºå®šé«˜åº¦ä¸æŠ˜å  */
#keyboard{height:260px;display:flex;flex-direction:column;background:var(--key);z-index:5;}
.row{display:flex;flex:1;}
.key{flex:1;margin:3px;border-radius:6px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:background .1s;}
.key:active{background:var(--theme);}
.key.fn{font-size:14px;background:#333;}
/* ä¿®å¤ï¼šæ‰‹ç»˜é¢æ¿ç‹¬ç«‹å±‚ï¼Œé¿å…ä¸ä¸»ç•Œé¢å†²çª */
#drawPanel{position:fixed;top:0;left:0;right:0;bottom:0;background:#000;display:flex;flex-direction:column;z-index:1000;/* æœ€é«˜å±‚çº§ï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ */}
#drawTop{height:auto;background:var(--theme);display:flex;flex-direction:column;gap:8px;padding:15px 12px;/* è¶³å¤Ÿé¡¶éƒ¨é—´è·ï¼Œé¿å¼€åœ°å€æ  */border-radius:0 0 8px 8px;}
#drawTop .operate-area{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
#latinIn{height:38px;padding:0 10px;border:none;border-radius:4px;flex:1;min-width:120px;font-size:16px;outline:none;/* å»é™¤èšç„¦è¾¹æ¡†ï¼Œä¼˜åŒ–è§†è§‰ */}
#drawCanvas{flex:1;background:#000;cursor:crosshair;margin:10px;border:1px solid var(--border);}
#drawTools{padding:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
.btn{background:var(--theme);border:0;color:#fff;padding:8px 14px;border-radius:4px;cursor:pointer;white-space:nowrap;}
#localSaveBtn{background:#4CAF50;}
input[type=file]{display:none;}
label.btn{display:inline-block;}
#status{position:fixed;bottom:4px;left:50%;transform:translateX(-50%);background:#000;border:1px solid var(--border);padding:4px 12px;border-radius:12px;font-size:12px;color:var(--theme);z-index:20;}
/* é‡è½½æŒ‰é’®å±‚çº§è°ƒæ•´ */
.reload-btn{position:fixed;bottom:60px;right:8px;height:32px;border:none;border-radius:4px;background:var(--theme);color:#fff;cursor:pointer;z-index:20;}
</style>
</head>
<body>
<header>å¤§å‡‰è¯­è¾“å…¥æ³•å®‰å…¨ç‰ˆ</header>

<main>
  <div id="screen" contenteditable="true" placeholder="ç‚¹è¿™é‡Œè¾“å…¥â€¦"></div>
  <div id="toolbar">
    <span>å€™é€‰</span>
    <button onclick="openDraw()">âœï¸ ç»˜åˆ¶æ–°å­—ç¬¦</button>
  </div>
  <div id="candidate"></div>
  <div id="keyboard"></div>
</main>

<!-- æ‰‹ç»˜é¢æ¿ï¼šç»“æ„ç®€åŒ–ï¼Œç¡®ä¿ç‚¹å‡»äº‹ä»¶æ­£å¸¸ -->
<div id="drawPanel" style="display: none;">
  <div id="drawTop">
    <span style="font-weight:bold;font-size:16px;">ç»˜åˆ¶æ–°å­—ç¬¦</span>
    <div class="operate-area">
      <input id="latinIn" placeholder="å¯¹åº”æ‹‰ä¸å­—æ¯" maxlength="20"/>
      <button class="btn" id="saveBtn" onclick="saveGlyph()">ä¸Šä¼ GitHub</button>
      <button class="btn" id="localSaveBtn" onclick="saveGlyphLocally()">æœ¬åœ°ä¿å­˜</button>
      <button class="btn" onclick="closeDraw()">å…³é—­</button>
    </div>
  </div>
  <canvas id="drawCanvas"></canvas>
  <div id="drawTools">
    <label class="btn">ç¬”å®½<input type="range" id="brushW" min="2" max="40" value="6"></label>
    <button class="btn" onclick="toogleEraser()">æ©¡çš®æ“¦</button>
    <button class="btn" onclick="clearDraw()">æ¸…å±</button>
    <button class="btn" onclick="undoStroke()">æ’¤é”€</button>
    <label class="btn">ä¸Šä¼ åº•å›¾<input type="file" id="bgFile" accept="image/*"></label>
  </div>
</div>

<span id="status">å°±ç»ª</span>
<!-- ä¿®å¤ï¼šæŒ‰é’®æ·»åŠ IDï¼Œé¿å…æ ·å¼å†²çªå¯¼è‡´ç‚¹å‡»æ— æ•ˆ -->
<button class="reload-btn" onclick="location.reload()">ğŸ”„ é‡è½½å­—ç¬¦</button>

<script>
/***************  é…ç½®  ****************/
const owner='Zhou-Yihui';   // ä»…ä¿®æ”¹æ­¤å¤„
const repo='daliang';
let token=localStorage.getItem('gtoken');
if(!token){
  // ä¿®å¤ï¼špromptå¼¹å‡ºæ—¶æœºè°ƒæ•´ï¼Œé¿å…é˜»å¡åˆå§‹åŒ–
  setTimeout(()=>{
    token=prompt('GitHub Personal Access Tokenï¼ˆä»…æœ¬åœ°å­˜å‚¨ï¼Œæ°¸ä¸è¿›æºç ï¼‰');
    if(token)localStorage.setItem('gtoken',token);
  },500);
}

/***************  å…¨å±€å˜é‡  ****************/
let layout='qwerty';
let shift=false;
let charTable={};
let imgBg=null;
let strokes=[],currStr=[];
let isDraw=false,isErase=false;
let drawCtx=null,canvas=null;
const LOCAL_CHAR_KEY='daliang_char_table';

/***************  åˆå§‹åŒ–ï¼šç¡®ä¿é”®ç›˜å’Œç»˜åˆ¶åŠŸèƒ½ä¼˜å…ˆåŠ è½½  ****************/
window.onload=()=>{
  // 1. ä¼˜å…ˆåˆå§‹åŒ–é”®ç›˜ï¼ˆè§£å†³é”®ç›˜ä¸æ˜¾ç¤ºé—®é¢˜ï¼‰
  renderKB();
  // 2. åˆå§‹åŒ–æ‰‹ç»˜é¢æ¿
  canvas=document.getElementById('drawCanvas');
  if(canvas){
    drawCtx=canvas.getContext('2d');
    resizeCanvas();
    window.addEventListener('resize',resizeCanvas);
    bindDrawEvents();
  }
  // 3. åŠ è½½å­—ç¬¦è¡¨ï¼ˆä¸é˜»å¡UIï¼‰
  loadLocalTable();
  setTimeout(()=>{
    loadRemoteTable().then(()=>{
      bindIME();
      status('åˆå§‹åŒ–å®Œæˆ');
    });
  },300);
};

// ä¿®å¤ï¼šç”»å¸ƒå°ºå¯¸è®¡ç®—ï¼Œé¿å…ä¾èµ–æœªåŠ è½½å…ƒç´ 
function resizeCanvas(){
  if(!canvas)return;
  const panel=document.getElementById('drawPanel');
  if(!panel)return;
  // è®¡ç®—å¯ç”¨é«˜åº¦ï¼šé¢æ¿é«˜åº¦ - é¡¶éƒ¨æ é«˜åº¦ - å·¥å…·åŒºé«˜åº¦ - è¾¹è·
  const topHeight=document.getElementById('drawTop').offsetHeight;
  const toolsHeight=document.getElementById('drawTools').offsetHeight;
  canvas.width=panel.clientWidth - 20; // å·¦å³å„10pxè¾¹è·
  canvas.height=panel.clientHeight - topHeight - toolsHeight - 30; // ä¸Šä¸‹é¢„ç•™30px
  // é‡æ–°ç»˜åˆ¶åº•å›¾ï¼ˆå¦‚æœæœ‰ï¼‰
  if(imgBg){
    drawCtx.drawImage(imgBg,0,0,canvas.width,canvas.height);
    redrawStrokes(); // é‡ç»˜ç”»ç¬”è½¨è¿¹
  }
}

/***************  GitHub API  ****************/
async function gh(method,path,body){
  if(!token)throw new Error('è¯·å…ˆè¾“å…¥GitHub Token');
  try{
    const res=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
      method,
      headers:{
        'Authorization':`token ${token}`,
        'Content-Type':'application/json',
        'Accept':'application/vnd.github.v3+json' // å…¼å®¹GitHub API
      },
      body:body?JSON.stringify(body):undefined,
      timeout:10000 // è¶…æ—¶æ—¶é—´ï¼Œé¿å…é•¿æœŸé˜»å¡
    });
    if(!res.ok){
      const err=await res.text();
      throw new Error(`APIé”™è¯¯: ${res.status} - ${err}`);
    }
    return res.json();
  }catch(e){
    throw new Error(`ç½‘ç»œ/APIé—®é¢˜: ${e.message}`);
  }
}

async function loadRemoteTable(){
  status('åŒæ­¥è¿œç¨‹å­—ç¬¦è¡¨â€¦');
  try{
    const {content}=await gh('GET','table.json');
    const remoteTable=JSON.parse(atob(content));
    // åˆå¹¶è¿œç¨‹è¡¨ï¼ˆå»é‡ï¼‰
    for(const [latin, chars] of Object.entries(remoteTable)){
      if(!charTable[latin])charTable[latin]=[];
      const existingUrls=charTable[latin[lmap(c=>c.url);
      const newChars=chars.filter(c=>!existingUrls.includes(c.url));
      charTable[latin]=[...charTable[latin],...newChars];
    }
    saveLocalTable();
    status('è¿œç¨‹åŒæ­¥å®Œæˆ');
  }catch(e){
    if(e.message.includes('Not Found')){
      status('è¿œç¨‹æ— è¡¨ï¼Œä½¿ç”¨æœ¬åœ°è¡¨');
    }else{
      status(`åŒæ­¥å¤±è´¥: ${e.message.slice(0,20)}`);
    }
  }
}

async function pushToGit(path,content,message){
  let sha=null;
  try{
    // å…ˆæŸ¥è¯¢æ˜¯å¦å­˜åœ¨è¯¥æ–‡ä»¶
    const res=await gh('GET',path);
    sha=res.sha;
  }catch(e){
    if(!e.message.includes('Not Found'))throw e;
  }
  // ä¸Šä¼ æ–‡ä»¶
  return gh('PUT',path,{
    message:message||`update ${path}`,
    content:btoa(typeof content==='string'?content:JSON.stringify(content)),
    sha,
    branch:'main' // æ˜ç¡®åˆ†æ”¯ï¼Œé¿å…é»˜è®¤åˆ†æ”¯é—®é¢˜
  });
}

/***************  æœ¬åœ°å­—ç¬¦è¡¨æ“ä½œ  ****************/
function loadLocalTable(){
  status('åŠ è½½æœ¬åœ°å­—ç¬¦è¡¨â€¦');
  try{
    const localData=localStorage.getItem(LOCAL_CHAR_KEY);
    if(localData)charTable=JSON.parse(localData);
    status('æœ¬åœ°è¡¨åŠ è½½å®Œæˆ');
  }catch(e){
    status('æœ¬åœ°è¡¨æŸåï¼Œæ–°å»º');
    charTable={};
    saveLocalTable();
  }
}

function saveLocalTable(){
  try{
    localStorage.setItem(LOCAL_CHAR_KEY,JSON.stringify(charTable));
  }catch(e){
    status(`æœ¬åœ°ä¿å­˜å¤±è´¥: ${e.message.slice(0,15)}`);
  }
}

// æœ¬åœ°ä¿å­˜å­—ç¬¦ï¼ˆä¸ä¸Šä¼ GitHubï¼‰
function saveGlyphLocally(){
  const latin=document.getElementById('latinIn').value.trim().toLowerCase();
  if(!latin){
    alert('è¯·è¾“å…¥æ‹‰ä¸é”®ï¼ˆå¦‚aã€bï¼‰');
    return;
  }
  if(!strokes.length){
    alert('è¯·å…ˆç»˜åˆ¶å­—ç¬¦');
    return;
  }

  try{
    // ç”Ÿæˆå›¾ç‰‡å¹¶ä¸‹è½½
    canvas.toBlob(blob=>{
      if(!blob)throw new Error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥');
      // 1. ä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`daliang_${latin}_${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(url);

      // 2. ä¿å­˜åˆ°æœ¬åœ°å­—ç¬¦è¡¨
      if(!charTable[latin])charTable[latin]=[];
      const newRec={
        url:url,
        type:'local',
        timestamp:Date.now()
      };
      charTable[latin[lpush(newRec);
      saveLocalTable();
      insertLocalCand(newRec);

      status('âœ… æœ¬åœ°ä¿å­˜æˆåŠŸ');
      clearDraw();
      document.getElementById('latinIn').value='';
    });
  }catch(e){
    status(`æœ¬åœ°ä¿å­˜å¤±è´¥: ${e.message}`);
    alert(`ä¿å­˜å¤±è´¥ï¼š${e.message}`);
  }
}

/***************  æ‰‹ç»˜åŠŸèƒ½  ****************/
function bindDrawEvents(){
  if(!canvas)return;

  // é¼ æ ‡/è§¦æ‘¸äº‹ä»¶ç»Ÿä¸€å¤„ç†
  const startDraw=(x,y)=>{
    isDraw=true;
    currStr=[{x,y}];
    drawCtx.beginPath();
    drawCtx.moveTo(x,y);
  };

  const moveDraw=(x,y)=>{
    if(!isDraw)return;
    const brushW=document.getElementById('brushW').value;
    // è®¾ç½®ç”»ç¬”/æ©¡çš®æ“¦å±æ€§
    drawCtx.lineWidth=isErase?brushW*2:brushW;
    drawCtx.globalCompositeOperation=isErase?'destination-out':'source-over';
    drawCtx.strokeStyle='#fff';
    drawCtx.lineCap='round'; // ç¬”è§¦åœ†æ¶¦
    drawCtx.lineTo(x,y);
    drawCtx.stroke();
    currStr.push({x,y});
  };

  const endDraw=()=>{
    if(isDraw&&currStr.length){
      strokes.push([...currStr]);
    }
    isDraw=false;
  };

  // é¼ æ ‡äº‹ä»¶
  canvas.addEventListener('mousedown',e=>{
    const {x,y}=getXY(e);
    startDraw(x,y);
  });
  canvas.addEventListener('mousemove',e=>{
    const {x,y}=getXY(e);
    moveDraw(x,y);
  });
  canvas.addEventListener('mouseup',endDraw);
  canvas.addEventListener('mouseout',endDraw);

  // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
  canvas.addEventListener('touchstart',e=>{
    e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨
    const touch=e.touches[0];
    const {x,y}=getXY(touch);
    startDraw(x,y);
  });
  canvas.addEventListener('touchmove',e=>{
    e.preventDefault();
    const touch=e.touches[0];
    const {x,y}=getXY(touch);
    moveDraw(x,y);
  });
  canvas.addEventListener('touchend',endDraw);
  canvas.addEventListener('touchcancel',endDraw);

  // åº•å›¾ä¸Šä¼ 
  document.getElementById('bgFile').addEventListener('change',e=>{
    const file=e.target.files[0];
    if(!file)return;
    const reader=new FileReader();
    reader.onload=function(e){
      imgBg=new Image();
      imgBg.onload=function(){
        resizeCanvas(); // é‡æ–°è°ƒæ•´ç”»å¸ƒå¹¶ç»˜åˆ¶åº•å›¾
      };
      imgBg.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

// ä¿®å¤ï¼šè·å–æ­£ç¡®çš„ç”»å¸ƒå†…åæ ‡
function getXY(e){
  const rect=canvas.getBoundingClientRect();
  return{
    x:e.clientX - rect.left,
    y:e.clientY - rect.top
  };
}

function clearDraw(){
  if(!drawCtx)return;
  drawCtx.clearRect(0,0,canvas.width,canvas.height);
  if(imgBg){
    drawCtx.drawImage(imgBg,0,0,canvas.width,canvas.height);
  }
  strokes=[];
}

function undoStroke(){
  if(strokes.length){
    strokes.pop();
    clearDraw();
    redrawStrokes();
  }else{
    status('æ— å†å²è½¨è¿¹å¯æ’¤é”€');
  }
}

function redrawStrokes(){
  if(!drawCtx||!strokes.length)return;
  drawCtx.save();
  drawCtx.strokeStyle='#fff';
  drawCtx.lineWidth=document.getElementById('brushW').value;
  drawCtx.lineCap='round';
  strokes.forEach(s=>{
    if(s.length){
      drawCtx.beginPath();
      drawCtx.moveTo(s[0].x,s[0].y);
      s.forEach(p=>drawCtx.lineTo(p.x,p.y));
      drawCtx.stroke();
    }
  });
  drawCtx.restore();
}

function toogleEraser(){
  isErase=!isErase;
  status(isErase?'æ©¡çš®æ“¦æ¨¡å¼':'ç»˜åˆ¶æ¨¡å¼');
}

// ä¿®å¤ï¼šç¡®ä¿ç»˜åˆ¶é¢æ¿èƒ½æ­£å¸¸æ˜¾ç¤º/éšè—
function openDraw(){
  const panel=document.getElementById('drawPanel');
  if(panel)panel.style.display='flex';
  setTimeout(resizeCanvas,100); // å»¶è¿Ÿè°ƒæ•´ç”»å¸ƒï¼Œç¡®ä¿é¢æ¿å·²æ¸²æŸ“
}

function closeDraw(){
  const panel=document.getElementById('drawPanel');
  if(panel)panel.style.display='none';
}

/***************  ä¸Šä¼ GitHubåŠŸèƒ½  ****************/
async function saveGlyph(){
  const latin=document.getElementById('latinIn').value.trim().toLowerCase();
  if(!latin){
    alert('è¯·è¾“å…¥æ‹‰ä¸é”®ï¼ˆå¦‚aã€bï¼‰');
    return;
  }
  if(!strokes.length){
    alert('è¯·å…ˆç»˜åˆ¶å­—ç¬¦');
    return;
  }
  const btn=document.getElementById('saveBtn');
  btn.disabled=true;
  btn.textContent='ä¸Šä¼ ä¸­â€¦';

  try{
    // 1. ç”Ÿæˆå›¾ç‰‡Base64
    const blob=await new Promise((res)=>{
      canvas.toBlob(res,'image/png',0.9);
    });
    const base64=await new Promise((r)=>{
      const reader=new FileReader();
      reader.onload=()=>r(reader.result.split(',')[1]);
      reader.readAsDataURL(blob);
    });

    // 2. ä¸Šä¼ å›¾ç‰‡åˆ°GitHub
    const filename=`chars/${latin}_${Date.now()}.png`;
    await pushToGit(filename,base64,`add char: ${latin}`);

    // 3. æ›´æ–°å­—ç¬¦è¡¨
    if(!charTable[latin])charTable[latin]=[];
    const newRec={
      url:`https://raw.githubusercontent.com/${owner}/${repo}/main/${filename}`,
      mirrorUrl:`https://github.moeyy.xyz/https://raw.githubusercontent.com/${owner}/${repo}/main/${filename}`,
      filename,
      type:'remote'
    };
    charTable[latin[lpush(newRec);

    // 4. ä¸Šä¼ æ›´æ–°åçš„å­—ç¬¦è¡¨
    await pushToGit('table.json',JSON.stringify(charTable,null,2),`update table for ${latin}`);

    // 5. æœ¬åœ°ç”Ÿæ•ˆ
    saveLocalTable();
    insertLocalCand({...newRec, url:newRec.mirrorUrl});

    status('âœ… ä¸Šä¼ æˆåŠŸï¼');
    clearDraw();
    document.getElementById('latinIn').value='';
    closeDraw();
  }catch(e){
    const errMsg=e.message.length>30?e.message.slice(0,30)+'...':e.message;
    status(`ä¸Šä¼ å¤±è´¥: ${errMsg}`);
    alert(`ä¸Šä¼ å¤±è´¥ï¼š${e.message}`);
  }finally{
    btn.disabled=false;
    btn.textContent='ä¸Šä¼ GitHub';
  }
}

/***************  å€™é€‰æ æ“ä½œ  ****************/
function insertLocalCand(rec){
  const box=document.getElementById('candidate');
  if(!box)return;

  const div=document.createElement('div');
  div.className='cand-char';

  const img=new Image();
  img.src=rec.url;
  img.style.height='32px';
  // å›¾ç‰‡åŠ è½½å¤±è´¥é™çº§
  img.onerror=()=>{
    if(rec.mirrorUrl){
      img.src=rec.mirrorUrl;
    }else{
      div.textContent=rec.url.split('/').pop().slice(0,2);
      div.style.fontSize='12px';
      div.style.color='#ccc';
    }
  };
  div.appendChild(img);

  // ç‚¹å‡»æ’å…¥è¾“å…¥æ¡†
  div.onclick=()=>{
    const scr=document.getElementById('screen');
    const container=document.createElement('span');
    container.style.display='inline-block';
    container.style.verticalAlign='middle';

    const charImg=new Image();
    charImg.src=rec.mirrorUrl||rec.url;
    charImg.style.height='1em';
    charImg.onerror=()=>{
      container.textContent=`[${rec.url.split('/').pop().slice(0,2)}]`;
      container.style.color='#ccc';
    };
    container.appendChild(charImg);
    scr.appendChild(container);
    scr.appendChild(document.createTextNode(' '));
  };
  box.appendChild(div);
}

/***************  é”®ç›˜åŠŸèƒ½  ****************/
const LAYOUTS={
  qwerty:[
    ['q','w','e','r','t','y','u','i','o','p'],
    ['a','s','d','f','g','h','j','k','l'],
    ['â‡§','z','x','c','v','b','n','m','âŒ«'],
    ['123','ğŸ¤',' ','â']
  ],
  digit:[
    ['1','2','3','4','5','6','7','8','9','0'],
    ['-','/',':',';','(',')','$','&','@','"'],
    ['#+=','.',',','?','!','\'','â‡§','âŒ«'],
    ['ABC','ğŸ¤',' ','â']
  ]
};

// ä¿®å¤ï¼šç¡®ä¿é”®ç›˜æ¸²æŸ“ä¸ä¾èµ–å¤–éƒ¨æ¡ä»¶
function renderKB(){
  const kb=document.getElementById('keyboard');
  if(!kb)return;
  kb.innerHTML=''; // æ¸…ç©ºæ—§é”®ç›˜

  const currentLayout=layout==='digit'?LAYOUTS.digit:LAYOUTS.qwerty;
  currentLayout.forEach(row=>{
    const rowEl=document.createElement('div');
    rowEl.className='row';

    row.forEach(keyText=>{
      const keyEl=document.createElement('div');
      keyEl.className='key';
      keyEl.textContent=keyText;

      // æ ‡è®°åŠŸèƒ½é”®
      if(['â‡§','123','ABC','ğŸ¤','â','âŒ«','#+='].includes(keyText)){
        keyEl.classList.add('fn');
      }
      // ShiftæŒ‰ä¸‹çŠ¶æ€
      if(keyText==='â‡§'&&shift){
        keyEl.style.background='var(--theme)';
      }
      // ç»‘å®šç‚¹å‡»äº‹ä»¶
      keyEl.addEventListener('click',()=>handleKey(keyText));
      rowEl.appendChild(keyEl);
    });
    kb.appendChild(rowEl);
  });
}

function handleKey(keyText){
  const scr=document.getElementById('screen');
  switch(keyText){
    case 'â‡§':
      shift=!shift;
      renderKB(); // é‡æ–°æ¸²æŸ“é”®ç›˜æ˜¾ç¤ºçŠ¶æ€
      break;
    case 'âŒ«':
      // æ”¯æŒåˆ é™¤æ–‡æœ¬å’Œå›¾ç‰‡
      if(scr.lastChild){
        // è‹¥æœ€åä¸€ä¸ªæ˜¯ç©ºæ ¼ï¼Œå…ˆåˆ ç©ºæ ¼
        if(scr.lastChild.nodeType===3&&scr.lastChild.textContent.trim()===''){
          scr.removeChild(scr.lastChild);
        }
        if(scr.lastChild){
          scr.removeChild(scr.lastChild);
        }
      }
      break;
    case 'â':
      scr.appendChild(document.createElement('br'));
      break;
    case '123':
      layout='digit';
      renderKB();
      break;
    case 'ABC':
      layout='qwerty';
      renderKB();
      break;
    case 'ğŸ¤':
      status('è¯­éŸ³åŠŸèƒ½é¢„ç•™');
      break;
    case ' ':
      scr.appendChild(document.createTextNode(' '));
      break;
    default:
      // è¾“å…¥æ‹‰ä¸å­—æ¯ï¼ˆå¤„ç†å¤§å°å†™ï¼‰
      const char=shift?keyText.toUpperCase():keyText.toLowerCase();
      scr.appendChild(document.createTextNode(char));
      // æ›´æ–°å€™é€‰æ 
      updateCand(char.toLowerCase());
      // è‡ªåŠ¨å–æ¶ˆShift
      if(shift&&!['â‡§','123','ABC'].includes(keyText)){
        shift=false;
        renderKB();
      }
      break;
  }
}

function updateCand(latin){
  const box=document.getElementById('candidate');
  if(!box)return;
  box.innerHTML='';

  const candidates=charTable[latin]||[];
  if(!candidates.length){
    box.innerHTML='<em style="color:#666">æ— å€™é€‰</em>';
    return;
  }

  candidates.forEach(cand=>{
    const div=document.createElement('div');
    div.className='cand-char';

    const img=new Image();
    img.src=cand.mirrorUrl||cand.url;
    img.style.height='32px';
    img.onerror=()=>{
      div.textContent=cand.url.split('/').pop().slice(0,2);
      div.style.fontSize='12px';
      div.style.color='#ccc';
    };
    div.appendChild(img);

    div.onclick=()=>{
      const scr=document.getElementById('screen');
      const container=document.createElement('span');
      container.style.display='inline-block';
      container.style.verticalAlign='middle';

      const charImg=new Image();
      charImg.src=cand.mirrorUrl||cand.url;
      charImg.style.height='1em';
      charImg.onerror=()=>{
        container.textContent=`[${cand.url.split('/').pop().slice(0,2)}]`;
        container.style.color='#ccc';
      };
      container.appendChild(charImg);
      scr.appendChild(container);
      scr.appendChild(document.createTextNode(' '));
    };
    box.appendChild(div);
  });
}

/***************  è¾…åŠ©åŠŸèƒ½  ****************/
function bindIME(){
  const scr=document.getElementById('screen');
  if(!scr)return;

  // é•¿æŒ‰è¾“å…¥æ¡†æ‰“å¼€æ‰‹ç»˜é¢æ¿ï¼ˆç§»åŠ¨ç«¯ï¼‰
  let longPressTimer=null;
  scr.addEventListener('touchstart',e=>{
    longPressTimer=setTimeout(()=>{
      openDraw();
      e.preventDefault();
    },500);
  });
  scr.addEventListener('touchend',()=>clearTimeout(longPressTimer));
  scr.addEventListener('touchcancel',()=>clearTimeout(longPressTimer));

  // ä¼˜åŒ–è¾“å…¥æ¡†æ¢è¡Œ
  scr.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.ctrlKey){
      e.preventDefault();
      scr.appendChild(document.createElement('br'));
    }
  });
}

// çŠ¶æ€æç¤ºå‡½æ•°
function status(msg){
  const statusEl=document.getElementById('status');
  if(statusEl)statusEl.textContent=msg;
  // 3ç§’åè‡ªåŠ¨æ¢å¤
  clearTimeout(statusEl?.timer);
  if(statusEl){
    statusEl.timer=setTimeout(()=>{
      statusEl.textContent='å°±ç»ª';
    },3000);
  }
}
</script>
</body>
</html>
