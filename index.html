<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<title>å¤§å‡‰è¯­è¾“å…¥æ³•Â·æ— å†²çªåŒæ­¥ç‰ˆ</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<style>
:root{
  --theme:#7c4dff;--bg:#121212;--key:#1e1e1e;--text:#fff;--border:rgba(255,255,255,.15);
  --scale:0.8;
}
*{box-sizing:border-box;font-family:Roboto,Helvetica Neue,PingFang SC;font-size:calc(14px * var(--scale));user-select:none}
body{margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh}
header{height:calc(40px * var(--scale));background:var(--theme);display:flex;align-items:center;padding:0 calc(10px * var(--scale));font-weight:bold}
main{flex:1;display:flex;flex-direction:column}
#screen{flex:1;padding:calc(10px * var(--scale));font-size:calc(24px * var(--scale));background:#000;border:1px solid var(--border);overflow-y:auto;white-space:pre-wrap;word-break:break-all}
#toolbar{height:calc(36px * var(--scale));display:flex;align-items:center;padding:0 calc(6px * var(--scale));border-bottom:1px solid var(--border)}
#toolbar button{margin-left:auto;height:calc(28px * var(--scale));border:none;border-radius:4px;background:var(--theme);color:#fff;padding:0 calc(10px * var(--scale));cursor:pointer}
#candidate{height:calc(40px * var(--scale));display:flex;align-items:center;padding:0 calc(6px * var(--scale));border-bottom:1px solid var(--border);overflow-x:auto}
.cand-char{height:calc(32px * var(--scale));margin:0 calc(4px * var(--scale));border:1px solid var(--border);border-radius:4px;background:var(--key);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.cand-char img{height:calc(28px * var(--scale));width:auto;pointer-events:none}
#keyboard{height:calc(220px * var(--scale));display:flex;flex-direction:column;background:var(--key);padding-bottom:env(safe-area-inset-bottom)}
.row{display:flex;flex:1}
.key{flex:1;margin:calc(3px * var(--scale));border-radius:calc(6px * var(--scale));background:#2a2a2a;display:flex;align-items:center;justify-content:center;font-size:calc(18px * var(--scale));cursor:pointer;transition:background .1s}
.key:active{background:var(--theme)}
.key.fn{font-size:calc(14px * var(--scale));background:#333}
#drawPanel{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;z-index:1000}
#drawTop{height:calc(44px * var(--scale));background:var(--theme);display:flex;align-items:center;justify-content:space-between;padding:0 calc(10px * var(--scale))}
#drawCanvas{flex:1;background:#000;cursor:crosshair}
#drawTools{padding:calc(8px * var(--scale));display:flex;gap:calc(8px * var(--scale));flex-wrap:wrap}
.btn{background:var(--theme);border:0;color:#fff;padding:calc(8px * var(--scale)) calc(14px * var(--scale));border-radius:4px;cursor:pointer}
#permBtn{background:#4CAF50}
input[type=file]{display:none}
label.btn{display:inline-block}
#status{position:fixed;bottom:4px;left:50%;transform:translateX(-50%);background:#000;border:1px solid var(--border);padding:4px 12px;border-radius:12px;font-size:calc(12px * var(--scale));color:var(--theme)}
#latinIn{height:calc(28px * var(--scale));font-size:calc(13px * var(--scale));padding:0 6px;border-radius:4px;border:1px solid var(--border);background:#000;color:var(--text)}
</style>
</head>
<body>
<header>å¤§å‡‰è¯­è¾“å…¥æ³•Â·æ— å†²çªåŒæ­¥ç‰ˆ</header>
<main>
  <div id="screen" contenteditable="true" placeholder="ç‚¹è¿™é‡Œè¾“å…¥â€¦"></div>
  <div id="toolbar">
    <span>å€™é€‰</span>
    <button onclick="openDraw()">âœï¸ ç»˜åˆ¶</button>
  </div>
  <div id="candidate"></div>
  <div id="keyboard"></div>
</main>

<div id="drawPanel" style="display:none">
  <div id="drawTop">
    <span>ç»˜åˆ¶æ–°å­—ç¬¦</span>
    <div>
      <input id="latinIn" placeholder="å¯¹åº”æ‹‰ä¸å­—æ¯" maxlength="20"/>
      <button class="btn" id="permBtn" onclick="permSave()">æ°¸ä¹…ä¿å­˜</button>
      <button class="btn" onclick="closeDraw()">å…³é—­</button>
    </div>
  </div>
  <canvas id="drawCanvas"></canvas>
  <div id="drawTools">
    <label class="btn">ç¬”å®½<input type="range" id="brushW" min="2" max="40" value="6"></label>
    <button class="btn" onclick="toogleEraser()">æ©¡çš®æ“¦</button>
    <button class="btn" onclick="clearDraw()">æ¸…å±</button>
    <button class="btn" onclick="undoStroke()">æ’¤é”€</button>
    <label class="btn">ä¸Šä¼ åº•å›¾<input type="file" id="bgFile" accept="image/*"></label>
  </div>
</div>

<span id="status">å°±ç»ª</span>
<button onclick="location.reload()" style="position:fixed;bottom:60px;right:8px;height:32px;border:none;border-radius:4px;background:var(--theme);color:#fff;cursor:pointer">ğŸ”„ é‡è½½å­—ç¬¦</button>

<script>
/* ==================  ä½ çš„ä»“åº“  ================== */
const owner = 'Zhou-Yihui';
const repo  = 'daliang';

/* ==================  Token  ================== */
let token = localStorage.getItem('gtoken');
if (!token) {
  token = prompt('GitHub Personal Access Tokenï¼ˆä»…æœ¬åœ°å­˜å‚¨ï¼‰');
  if (token) localStorage.setItem('gtoken', token);
}

/* ==================  å…¨å±€å˜é‡  ================== */
let layout = 'qwerty', shift = false, charTable = {};
let imgBg, strokes = [], currStr = [], isDraw = false, isErase = false;
let drawCtx, canvas;
const LOCAL_CHAR_KEY = 'daliang_char_table';

/* ==================  100 vh ä¿®å¤  ================== */
function fix100vh() {
  const h = window.visualViewport ? window.visualViewport.height : window.innerHeight;
  document.documentElement.style.height = h + 'px';
  document.body.style.height = h + 'px';
}
window.addEventListener('resize', fix100vh);
window.addEventListener('scroll', fix100vh);
if (window.visualViewport) visualViewport.addEventListener('resize', fix100vh);

/* ==================  åˆå§‹åŒ–ï¼ˆæ— å†²çªåŒæ­¥ç‰ˆï¼‰  ================== */
window.onload = async () => {
  fix100vh();
  canvas = document.getElementById('drawCanvas');
  drawCtx = canvas.getContext('2d');
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  bindDrawEvents();

  // 1. å…ˆè¯»æœ¬åœ°ï¼ˆä¼˜å…ˆç›¸ä¿¡æœ¬åœ°ï¼‰
  loadLocalTable();

  // 2. æ‹‰è¿œç¨‹ï¼Œä½†è¿œç¨‹ç©ºè¡¨æ—¶ä¸è¦†ç›–æœ¬åœ°
  await loadRemoteTable_KeepLocal();

  // 3. æ¸…æ‰æ—§ blob
  cleanupBlob();
  // 4. ç»§ç»­åŸæµç¨‹
  renderKB();
  bindIME();
};

/* ==================  æ— å†²çªåŒæ­¥ï¼šåˆå¹¶æœ¬åœ°æ–°å¢  ================== */
function mergeLocalNew() {
  const raw = localStorage.getItem(LOCAL_CHAR_KEY);
  if (!raw) return;
  const local = JSON.parse(raw);
  for (const latin in local) {
    if (!Array.isArray(local[latin])) continue;
    if (!charTable[latin]) charTable[latin] = [];
    const remoteSet = new Set(charTable[latin].map(it => it.url));
    const add = local[latin].filter(it => !remoteSet.has(it.url));
    charTable[latin].push(...add);
  }
  saveLocalTable();   // åˆå¹¶åå†™å›
}

/* ==================  ç”»å¸ƒ & æ‰‹ç»˜  ================== */
function resizeCanvas() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.clientWidth * dpr;
  canvas.height = canvas.clientHeight * dpr;
  drawCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
  if (imgBg) drawCtx.drawImage(imgBg, 0, 0, canvas.width, canvas.height);
}
function bindDrawEvents() {
  const down = e => {
    isDraw = true; currStr = []; const { x, y } = getXY(e);
    drawCtx.beginPath(); drawCtx.moveTo(x, y); currStr.push({ x, y });
  };
  const move = e => {
    if (!isDraw) return; const { x, y } = getXY(e);
    drawCtx.lineWidth = isErase ? document.getElementById('brushW').value * 2 : document.getElementById('brushW').value;
    drawCtx.globalCompositeOperation = isErase ? 'destination-out' : 'source-over';
    drawCtx.strokeStyle = '#fff'; drawCtx.lineTo(x, y); drawCtx.stroke();
    currStr.push({ x, y });
  };
  const up = () => { isDraw = false; if (currStr.length) strokes.push([...currStr]); };
  canvas.onmousedown = down; canvas.onmousemove = move; canvas.onmouseup = up; canvas.onmouseout = up;
  canvas.ontouchstart = e => { e.preventDefault(); down(e.touches[0]); };
  canvas.ontouchmove = e => { e.preventDefault(); move(e.touches[0]); };
  canvas.ontouchend = up;
  document.getElementById('bgFile').onchange = e => {
    const file = e.target.files[0]; if (!file) return;
    imgBg = new Image(); imgBg.onload = () => { drawCtx.drawImage(imgBg, 0, 0, canvas.width, canvas.height); };
    imgBg.src = URL.createObjectURL(file);
  };
}
function getXY(e) { const r = canvas.getBoundingClientRect(); return { x: e.clientX - r.left, y: e.clientY - r.top }; }
function clearDraw() { drawCtx.clearRect(0, 0, canvas.width, canvas.height); if (imgBg) drawCtx.drawImage(imgBg, 0, 0, canvas.width, canvas.height); strokes = []; }
function undoStroke() { strokes.pop(); clearDraw(); redrawStrokes(); }
function redrawStrokes() {
  drawCtx.save(); drawCtx.strokeStyle = '#fff'; drawCtx.lineWidth = document.getElementById('brushW').value; drawCtx.lineCap = 'round';
  strokes.forEach(s => { if (s.length) { drawCtx.beginPath(); drawCtx.moveTo(s[0].x, s[0].y); s.forEach(p => drawCtx.lineTo(p.x, p.y)); drawCtx.stroke(); } });
  drawCtx.restore();
}
function toogleEraser() { isErase = !isErase; status(isErase ? 'æ©¡çš®æ“¦' : 'ç»˜åˆ¶'); }
function openDraw() { document.getElementById('drawPanel').style.display = 'flex'; resizeCanvas(); }
function closeDraw() { document.getElementById('drawPanel').style.display = 'none'; }

/* ==================  ä¸€é”®æ°¸ä¹…ä¿å­˜ï¼šæœ¬åœ°+GitHub  ================== */
async function permSave() {
  const latin = document.getElementById('latinIn').value.trim().toLowerCase();
  if (!latin) { alert('è¯·è¾“å…¥æ‹‰ä¸å­—æ¯'); return; }
  if (!strokes.length) { alert('è¯·å…ˆç»˜åˆ¶å­—ç¬¦'); return; }
  status('æ­£åœ¨æ°¸ä¹…ä¿å­˜â€¦');
  try {
    // 1. æœ¬åœ°æ°¸ä¹…ä¿å­˜ï¼ˆdataURLï¼‰
    const blob = await new Promise(res => canvas.toBlob(res));
    const dataURL = await new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(blob);
    });
    if (!charTable[latin]) charTable[latin] = [];
    charTable[latin].push({ url: dataURL, type: 'local', ts: Date.now() });

    // 2. ä¸Šä¼  GitHubï¼ˆå…ˆå–æœ€æ–° sha é˜² 409ï¼‰
    const base64 = dataURL.split(',')[1];
    const filename = `chars/${latin}_${Date.now()}.png`;
    await pushToGit(filename, base64, 'add char ' + latin);
    const record = {
      url: `https://raw.githubusercontent.com/${owner}/${repo}/main/${filename}`,
      mirrorUrl: `https://github.moeyy.xyz/https://raw.githubusercontent.com/${owner}/${repo}/main/${filename}`,
      filename, type: 'remote'
    };
    charTable[latin].push(record);
    await pushToGit('table.json', JSON.stringify(charTable, null, 2), 'update table');

    // 3. ç«‹å³æ’å…¥å€™é€‰æ 
    insertLocalCand(record);
    saveLocalTable();
    status('âœ… å·²æ°¸ä¹…ä¿å­˜ï¼ˆæœ¬åœ°+GitHubï¼‰');
    clearDraw();
    document.getElementById('latinIn').value = '';
  } catch (e) {
    status('ä¿å­˜å¤±è´¥ ' + e.message);
    alert('ä¿å­˜å¤±è´¥\n' + e.message);
  }
}
function insertLocalCand(rec) {
  const box = document.getElementById('candidate');
  const div = document.createElement('div'); div.className = 'cand-char';
  const img = new Image(); img.style.height = '32px'; img.src = rec.mirrorUrl || rec.url;
  img.onerror = () => { div.textContent = rec.url.split('/').pop().slice(0, 2); div.style.fontSize = '12px'; div.style.color = '#ccc'; };
  div.appendChild(img);
  div.onclick = () => {
    const scr = document.getElementById('screen');
    const wrap = document.createElement('span'); wrap.style.display = 'inline-block'; wrap.style.verticalAlign = 'middle';
    const im = new Image(); im.style.height = '1em'; im.src = rec.mirrorUrl || rec.url;
    im.onerror = () => { wrap.textContent = `[${rec.url.split('/').pop().slice(0, 2)}]`; wrap.style.color = '#ccc'; };
    wrap.appendChild(im); scr.appendChild(wrap); scr.appendChild(document.createTextNode(' '));
  };
  box.appendChild(div);
}
function cleanupBlob() {
  let dirty = false;
  for (const latin in charTable) {
    charTable[latin] = charTable[latin].filter(rec => {
      const ok = rec.url.startsWith('data:') || rec.url.startsWith('http');
      if (!ok) dirty = true;
      return ok;
    });
    if (charTable[latin].length === 0) delete charTable[latin];
  }
  if (dirty) localStorage.setItem(LOCAL_CHAR_KEY, JSON.stringify(charTable));
}

/* ==================  æœ¬åœ°å­˜å–  ================== */
function loadLocalTable() {
  try {
    const raw = localStorage.getItem(LOCAL_CHAR_KEY);
    if (raw) charTable = JSON.parse(raw);
  } catch {
    charTable = {};
  }
}
function saveLocalTable() {
  localStorage.setItem(LOCAL_CHAR_KEY, JSON.stringify(charTable));
}

/* ==================  åŒæ­¥ï¼šæ‹‰è¿œç¨‹ + åˆå¹¶ï¼ˆè¿œç¨‹ç©ºè¡¨æ—¶ä¸è¦†ç›–ï¼‰  ================== */
async function loadRemoteTable_KeepLocal() {
  status('åŒæ­¥è¿œç¨‹å­—ç¬¦è¡¨â€¦');
  try {
    const { content } = await gh('GET', 'table.json');
    const remoteTable = JSON.parse(atob(content));

    // å…³é”®ï¼šè¿œç¨‹ç©ºè¡¨æˆ–å­—æ®µç¼ºå¤± â†’ ç›´æ¥è·³è¿‡
    if (!remoteTable || !Object.keys(remoteTable).length) {
      status('è¿œç¨‹ç©ºè¡¨ï¼Œä¿ç•™æœ¬åœ°');
      return;
    }

    // æ­£å¸¸åˆå¹¶ï¼ˆä½ åŸæ¥çš„é€»è¾‘ï¼‰
    for (const [latin, chars] of Object.entries(remoteTable)) {
      if (!charTable[latin]) charTable[latin] = [];
      const existing = new Set(charTable[latin].map(c => c.url));
      const add = chars.filter(c => !existing.has(c.url));
      charTable[latin].push(...add);
    }
    saveLocalTable();
    status('è¿œç¨‹åŒæ­¥å®Œæˆ');
  } catch (e) {
    if (e.message.includes('Not Found')) {
      status('è¿œç¨‹æ— è¡¨ï¼Œå®Œå…¨ä½¿ç”¨æœ¬åœ°');
    } else {
      status('åŒæ­¥å¤±è´¥ ' + e.message);
    }
  }
}

/* ==================  GitHub ç®€æ˜“å°è£…  ================== */
async function gh(method, path, body) {
  const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const opt = {
    method,
    headers: {
      Authorization: `token ${token}`,
      Accept: 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: body ? JSON.stringify(body) : undefined
  };
  const r = await fetch(url, opt);
  if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}
async function pushToGit(path, content, message) {
  // å…ˆå– sha
  let sha;
  try {
    const info = await gh('GET', path);
    sha = info.sha;
  } catch (e) {
    if (!e.message.includes('Not Found')) throw e;
  }
  const body = {
    message,
    content,
    sha
  };
  return gh('PUT', path, body);
}

/* ==================  é”®ç›˜ & çŠ¶æ€  ================== */
const LAYOUTS = {
  qwerty: [
    ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
    ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l'],
    ['â‡§', 'z', 'x', 'c', 'v', 'b', 'n', 'm', 'âŒ«'],
    ['123', 'ğŸ¤', ' ', 'â']
  ],
  digit: [
    ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
    ['-', '/', ':', ';', '(', ')', '$', '&', '@', '"'],
    ['#+=', '.', ',', '?', '!', '\'', 'â‡§', 'âŒ«'],
    ['ABC', 'ğŸ¤', ' ', 'â']
  ]
};
function renderKB() {
  const kb = document.getElementById('keyboard');
  kb.innerHTML = '';
  const lay = layout === 'digit' ? LAYOUTS.digit : LAYOUTS.qwerty;
  lay.forEach(row => {
    const r = document.createElement('div'); r.className = 'row';
    row.forEach(k => {
      const key = document.createElement('div'); key.className = 'key'; key.textContent = k;
      if (k === 'â‡§' || k === '123' || k === 'ABC' || k === 'ğŸ¤' || k === 'â' || k === 'âŒ«' || k === '#+=') key.classList.add('fn');
      if (k === 'â‡§' && shift) key.style.background = 'var(--theme)';
      key.onclick = () => handleKey(k);
      r.appendChild(key);
    });
    kb.appendChild(r);
  });
}
function handleKey(k) {
  const scr = document.getElementById('screen');
  if (k === 'â‡§') { shift = !shift; renderKB(); return; }
  if (k === 'âŒ«') {
    if (scr.lastChild) scr.removeChild(scr.lastChild);
    return;
  }
  if (k === 'â') { scr.appendChild(document.createElement('br')); return; }
  if (k === '123') { layout = 'digit'; renderKB(); return; }
  if (k === 'ABC') { layout = 'qwerty'; renderKB(); return; }
  if (k === 'ğŸ¤') { status('è¯­éŸ³æ¥å£é¢„ç•™'); return; }
  if (k === ' ') { scr.appendChild(document.createTextNode(' ')); return; }
  const l = shift ? k.toUpperCase() : k;
  scr.appendChild(document.createTextNode(l));
  updateCand(l);
  if (shift && !['â‡§', '123', 'ABC'].includes(k)) { shift = false; renderKB(); }
}
function updateCand(l) {
  const box = document.getElementById('candidate');
  box.innerHTML = '';
  const list = charTable[l] || [];
  if (!list.length) { box.innerHTML = '<em style="color:#666">æ— å€™é€‰</em>'; return; }
  list.forEach(rec => {
    const div = document.createElement('div'); div.className = 'cand-char';
    const img = new Image(); img.style.height = '32px'; img.src = rec.mirrorUrl || rec.url;
    img.onerror = () => { div.textContent = rec.url.split('/').pop().slice(0, 2); div.style.fontSize = '12px'; div.style.color = '#ccc'; };
    div.appendChild(img);
    div.onclick = () => {
      const scr = document.getElementById('screen');
      const wrap = document.createElement('span'); wrap.style.display = 'inline-block'; wrap.style.verticalAlign = 'middle';
      const im = new Image(); im.style.height = '1em'; im.src = rec.mirrorUrl || rec.url;
      im.onerror = () => { wrap.textContent = `[${rec.url.split('/').pop().slice(0, 2)}]`; wrap.style.color = '#ccc'; };
      wrap.appendChild(im); scr.appendChild(wrap); scr.appendChild(document.createTextNode(' '));
    };
    box.appendChild(div);
  });
}
function bindIME() {
  const scr = document.getElementById('screen');
  let timer;
  scr.addEventListener('touchstart', e => {
    timer = setTimeout(() => { openDraw(); e.preventDefault(); }, 500);
  });
  scr.addEventListener('touchend', () => clearTimeout(timer));
  scr.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.ctrlKey) { e.preventDefault(); scr.appendChild(document.createElement('br')); }
  });
}
function status(msg) {
  const s = document.getElementById('status');
  s.textContent = msg;
  clearTimeout(s.timer);
  s.timer = setTimeout(() => s.textContent = 'å°±ç»ª', 3000);
}
</script>
</body>
</html>
