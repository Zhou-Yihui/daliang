<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<title>大凉语输入法安全版</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<style>
:root{--theme:#7c4dff;--bg:#121212;--key:#1e1e1e;--text:#fff;--border:rgba(255,255,255,.15)}
*{box-sizing:border-box;font-family:Roboto,Helvetica Neue,PingFang SC}
body{margin:0;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
header{height:48px;background:var(--theme);display:flex;align-items:center;padding:0 12px;font-weight:bold}
main{flex:1;display:flex;flex-direction:column}
#screen{flex:1;padding:12px;font-size:24px;background:#000;border:1px solid var(--border);overflow-y:auto;white-space:pre-wrap;word-break:break-all}
#toolbar{height:42px;display:flex;align-items:center;padding:0 8px;border-bottom:1px solid var(--border)}
#toolbar button{margin-left:auto;height:32px;border:none;border-radius:4px;background:var(--theme);color:#fff;padding:0 12px;cursor:pointer}
#candidate{height:46px;display:flex;align-items:center;padding:0 8px;border-bottom:1px solid var(--border);overflow-x:auto}
.cand-char{height:36px;margin:0 4px;border:1px solid var(--border);border-radius:4px;background:var(--key);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.cand-char img{height:32px;width:auto;pointer-events:none}
#keyboard{height:260px;display:flex;flex-direction:column;background:var(--key)}
.row{display:flex;flex:1}
.key{flex:1;margin:3px;border-radius:6px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;transition:background .1s}
.key:active{background:var(--theme)}
.key.fn{font-size:14px;background:#333}
/* 修复：手绘面板顶部布局，增加内边距避免被地址栏遮挡 */
#drawPanel{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;z-index:1000;padding-top:10px;/* 顶部预留10px避免紧贴屏幕边缘 */}
#drawTop{height:auto;/* 取消固定高度，适配内容 */background:var(--theme);display:flex;flex-direction:column;/* 垂直排列标题和操作区，避免横向拥挤 */gap:8px;padding:12px;/* 增加上下内边距，提升间距 */border-radius:0 0 8px 8px;/* 底部圆角优化视觉 */}
/* 新增：操作区横向布局，确保按钮和输入栏排列合理 */
#drawTop .operate-area{display:flex;align-items:center;gap:8px;flex-wrap:wrap;/* 自适应换行，避免移动端溢出 */}
/* 优化：拉丁输入栏样式，增加高度和内边距，提升点击区域 */
#latinIn{height:36px;padding:0 10px;border:none;border-radius:4px;flex:1;/* 占满剩余空间，适配不同屏幕 */min-width:120px;/* 最小宽度，避免过窄 */font-size:16px;}
#drawCanvas{flex:1;background:#000;cursor:crosshair;margin:10px;/* 画布边缘间距，避免紧贴面板 */border:1px solid var(--border);/* 画布边框，明确边界 */}
#drawTools{padding:8px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;/* 工具按钮居中，提升移动端体验 */}
.btn{background:var(--theme);border:0;color:#fff;padding:8px 14px;border-radius:4px;cursor:pointer;white-space:nowrap;/* 按钮文字不换行 */}
/* 优化：本地保存按钮样式，保持视觉区分 */
#localSaveBtn{background:#4CAF50}
input[type=file]{display:none}
label.btn{display:inline-block}
#status{position:fixed;bottom:4px;left:50%;transform:translateX(-50%);background:#000;border:1px solid var(--border);padding:4px 12px;border-radius:12px;font-size:12px;color:var(--theme)}
</style>
</head>
<body>
<header>大凉语输入法安全版</header>

<main>
  <div id="screen" contenteditable="true" placeholder="点这里输入…"></div>
  <div id="toolbar">
    <span>候选</span>
    <button onclick="openDraw()">✍️ 绘制新字符</button>
  </div>
  <div id="candidate"></div>
  <div id="keyboard"></div>
</main>

<!-- 手绘面板：调整结构为垂直布局，解决遮挡问题 -->
<div id="drawPanel" style="display:none">
  <div id="drawTop">
    <span style="font-weight:bold;font-size:16px;">绘制新字符</span>
    <!-- 新增操作区容器，优化布局结构 -->
    <div class="operate-area">
      <input id="latinIn" placeholder="对应拉丁字母" maxlength="20"/>
      <button class="btn" id="saveBtn" onclick="saveGlyph()">保存并上传(GitHub)</button>
      <button class="btn" id="localSaveBtn" onclick="saveGlyphLocally()">本地保存</button>
      <button class="btn" onclick="closeDraw()">关闭</button>
    </div>
  </div>
  <canvas id="drawCanvas"></canvas>
  <div id="drawTools">
    <label class="btn">笔宽<input type="range" id="brushW" min="2" max="40" value="6"></label>
    <button class="btn" onclick="toogleEraser()">橡皮擦</button>
    <button class="btn" onclick="clearDraw()">清屏</button>
    <button class="btn" onclick="undoStroke()">撤销</button>
    <label class="btn">上传底图<input type="file" id="bgFile" accept="image/*"></label>
  </div>
</div>

<span id="status">就绪</span>
<button onclick="location.reload()" style="position:fixed;bottom:60px;right:8px;height:32px;border:none;border-radius:4px;background:var(--theme);color:#fff;cursor:pointer">🔄 重载字符</button>

<script>
/***************  配置  ****************/
const owner='Zhou-Yihui';   //  ← 只改这里
const repo='daliang';          //  仓库名
let token=localStorage.getItem('gtoken');
if(!token){
  token=prompt('GitHub Personal Access Token（仅本地存储，永不进源码）');
  if(token)localStorage.setItem('gtoken',token);
}

/***************  全局变量  ****************/
let layout='qwerty';
let page=0;
let shift=false;
let charTable={};
let imgBg;          // 手绘底图
let strokes=[],currStr=[];
let isDraw=false,isErase=false;
let drawCtx,canvas;
const LOCAL_CHAR_KEY='daliang_char_table'; // 本地存储键名

/***************  初始化  ****************/
window.onload=()=>{
  canvas=document.getElementById('drawCanvas');
  drawCtx=canvas.getContext('2d');
  resizeCanvas();
  window.addEventListener('resize',resizeCanvas);
  bindDrawEvents();
  loadLocalTable(); // 优先加载本地字符表
  loadRemoteTable().then(()=>{
    renderKB();
    bindIME();
  });
};
function resizeCanvas(){
  // 修复：画布尺寸适配面板，减去边缘间距
  const panel=document.getElementById('drawPanel');
  canvas.width=panel.clientWidth - 20; // 减去左右各10px margin
  canvas.height=panel.clientHeight - document.getElementById('drawTop').offsetHeight - document.getElementById('drawTools').offsetHeight - 40; // 减去顶部、工具区高度和预留间距
  if(imgBg)drawCtx.drawImage(imgBg,0,0,canvas.width,canvas.height);
}

/***************  GitHub API  ****************/
async function gh(method,path,body){
  const res=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{
    method,headers:{Authorization:`token ${token}`,'Content-Type':'application/json'},
    body:body?JSON.stringify(body):undefined
  });
  if(!res.ok)throw new Error(await res.text());
  return res.json();
}
async function loadRemoteTable(){
  status('同步远程字符表…');
  try{
    const {content}=await gh('GET','table.json');
    const remoteTable=JSON.parse(atob(content));
    // 合并远程表到本地表（去重）
    for(const [latin, chars] of Object.entries(remoteTable)){
      if(!charTable[latin])charTable[latin]=[];
      const existingUrls=charTable[latin[lmap(c=>c.url);
      const newChars=chars.filter(c=>!existingUrls.includes(c.url));
      charTable[latin]=[...charTable[latin],...newChars];
    }
    saveLocalTable(); // 合并后保存到本地
    status('远程同步完成');
  }catch(e){
    if(e.message.includes('Not Found')){status('远程无表，使用本地表');}
    else status('同步失败 '+e.message);
  }
}
async function pushToGit(path,content,message){
  let sha;
  try{sha=(await gh('GET',path)).sha;}catch(e){}
  await gh('PUT',path,{
    message:message||'update '+path,
    content:btoa(typeof content==='string'?content:JSON.stringify(content)),
    sha
  });
}

/***************  本地字符表操作  ****************/
function loadLocalTable(){
  status('加载本地字符表…');
  try{
    const localData=localStorage.getItem(LOCAL_CHAR_KEY);
    if(localData)charTable=JSON.parse(localData);
    status('本地表加载完成');
  }catch(e){
    status('本地表损坏，新建');
    charTable={};
    saveLocalTable();
  }
}
function saveLocalTable(){
  try{
    localStorage.setItem(LOCAL_CHAR_KEY,JSON.stringify(charTable));
  }catch(e){
    status('本地保存失败：'+e.message);
  }
}
// 本地保存单个字符（不上传GitHub）
function saveGlyphLocally(){
  const latin=document.getElementById('latinIn').value.trim().toLowerCase();
  if(!latin){alert('请输入拉丁键');return;}
  if(!strokes.length){alert('请绘制字符');return;}

  try{
    // 生成图片Blob并获取本地URL
    canvas.toBlob(blob=>{
      const localUrl=URL.createObjectURL(blob);
      // 保存到本地字符表
      if(!charTable[latin])charTable[latin]=[];
      const newRec={
        url:localUrl,
        type:'local',
        timestamp:Date.now()
      };
      charTable[latin[lpush(newRec);
      saveLocalTable(); // 保存到本地存储
      insertLocalCand(newRec); // 加入候选栏
      
      // 自动下载图片到本地
      const a=document.createElement('a');
      a.href=localUrl;
      a.download=`daliang_${latin}_${Date.now()}.png`;
      a.click();
      URL.revokeObjectURL(localUrl); // 释放URL

      status('✅ 本地保存成功！');
      clearDraw();
      document.getElementById('latinIn').value='';
    });
  }catch(e){
    status('本地保存失败: '+e.message);
    alert('本地保存失败\n'+e.message);
  }
}

/***************  手绘  ****************/
function bindDrawEvents(){
  const down=e=>{
    isDraw=true;currStr=[];const {x,y}=getXY(e);
    drawCtx.beginPath();drawCtx.moveTo(x,y);currStr.push({x,y});
  };
  const move=e=>{
    if(!isDraw)return;const {x,y}=getXY(e);
    drawCtx.lineWidth=isErase?document.getElementById('brushW').value*2:document.getElementById('brushW').value;
    drawCtx.globalCompositeOperation=isErase?'destination-out':'source-over';
    drawCtx.strokeStyle='#fff';drawCtx.lineTo(x,y);drawCtx.stroke();
    currStr.push({x,y});
  };
  const up=()=>{isDraw=false;if(currStr.length)strokes.push([...currStr]);};
  // 鼠标事件
  canvas.onmousedown=down;canvas.onmousemove=move;canvas.onmouseup=up;canvas.onmouseout=up;
  // 触摸事件（适配移动端）
  canvas.ontouchstart=e=>{e.preventDefault();down(e.touches[0]);};
  canvas.ontouchmove=e=>{e.preventDefault();move(e.touches[0]);};
  canvas.ontouchend=up;
  // 底图上传
  document.getElementById('bgFile').onchange=e=>{
    const file=e.target.files[0];if(!file)return;
    imgBg=new Image();imgBg.onload=()=>{drawCtx.drawImage(imgBg,0,0,canvas.width,canvas.height);};
    imgBg.src=URL.createObjectURL(file);
  };
}
// 修复：获取触摸/鼠标在画布内的坐标（适配画布边框和间距）
function getXY(e){
  const r=canvas.getBoundingClientRect();
  return{
    x:e.clientX - r.left,
    y:e.clientY - r.top
  };
}
function clearDraw(){
  drawCtx.clearRect(0,0,canvas.width,canvas.height);
  if(imgBg)drawCtx.drawImage(imgBg,0,0,canvas.width,canvas.height);
  strokes=[];
}
function undoStroke(){
  strokes.pop();clearDraw();redrawStrokes();
}
function redrawStrokes(){
  drawCtx.save();
  drawCtx.strokeStyle='#fff';
  drawCtx.lineWidth=document.getElementById('brushW').value;
  drawCtx.lineCap='round'; // 笔触圆润，提升绘制体验
  strokes.forEach(s=>{
    if(s.length){
      drawCtx.beginPath();
      drawCtx.moveTo(s[0].x,s[0].y);
      s.forEach(p=>drawCtx.lineTo(p.x,p.y));
      drawCtx.stroke();
    }
  });
  drawCtx.restore();
}
function toogleEraser(){
  isErase=!isErase;
  status(isErase?'橡皮擦模式':'绘制模式');
}
function openDraw(){
  document.getElementById('drawPanel').style.display='flex';
  setTimeout(resizeCanvas,100); // 延迟调整画布，确保面板已显示
}
function closeDraw(){
  document.getElementById('drawPanel').style.display='none';
}

/***************  保存并上传GitHub  ****************/
async function saveGlyph(){
  const latin=document.getElementById('latinIn').value.trim().toLowerCase();
  if(!latin){alert('请输入拉丁键');return;}
  if(!strokes.length){alert('请绘制字符');return;}
  const btn=document.getElementById('saveBtn');
  btn.disabled=true; btn.textContent='上传中…';
  try{
    // 1. 生成PNG图片
    const blob=await new Promise(res=>drawCtx.canvas.toBlob(res));
    const base64=await new Promise(r=>{
      const reader=new FileReader();
      reader.onload=()=>r(reader.result.split(',')[1]);
      reader.readAsDataURL(blob);
    });
    const filename=`chars/${latin}_${Date.now()}.png`;

    // 2. 上传图片到GitHub
    await pushToGit(filename,base64,'add char '+latin);

    // 3. 更新字符表（含国内镜像链接）
    if(!charTable[latin])charTable[latin]=[];
    const newRec={
      url:`https://raw.githubusercontent.com/${owner}/${repo}/main/${filename}`,
      mirrorUrl:`https://github.moeyy.xyz/https://raw.githubusercontent.com/${owner}/${repo}/main/${filename}`, // 国内镜像
      filename,
      type:'remote'
    };
    charTable[latin[lpush(newRec);

    // 4. 上传更新后的字符表
    await pushToGit('
table.json',JSON.stringify(charTable,null,2),'update table');

    // 5. 本地生效并保存
    insertLocalCand({...newRec, url:newRec.mirrorUrl});
    saveLocalTable();

    status('✅ 上传并生效！');
    clearDraw();
    document.getElementById('latinIn').value='';
    closeDraw();
  }catch(e){
    status('上传失败: '+e.message);
    alert('上传失败\n'+e.message);
  }finally{
    btn.disabled=false; 
    btn.textContent='保存并上传(GitHub)';
  }
}

/* 插入候选字符到候选栏 */
function insertLocalCand(rec){
  const box=document.getElementById('candidate');
  const div=document.createElement('div');
  div.className='cand-char';
  
  const img=new Image();
  img.src=rec.url;
  img.style.height='32px';
  // 图片加载失败降级
  img.onerror=()=>{
    if(rec.mirrorUrl){
      img.src=rec.mirrorUrl;
    }else{
      div.innerHTML=`${rec.url.split('/').pop().slice(0,2)}`;
      div.style.fontSize='12px';
      div.style.color='#ccc';
    }
  };
  div.appendChild(img);

  // 点击候选字符插入到输入框
  div.onclick=()=>{
    const scr=document.getElementById('screen');
    const charContainer=document.createElement('span');
    charContainer.style.display='inline-block';
    charContainer.style.verticalAlign='middle';

    const im=new Image();
    im.src=rec.mirrorUrl||rec.url;
    im.style.height='1em';
    im.onerror=()=>{
      charContainer.textContent=`[${rec.url.split('/').pop().slice(0,2)}]`;
      charContainer.style.color='#ccc';
    };
    charContainer.appendChild(im);
    scr.appendChild(charContainer);
    scr.appendChild(document.createTextNode(' '));
  };
  box.appendChild(div);
}

/***************  键盘 & 候选  ****************/
const LAYOUTS={
  qwerty:[
    ['q','w','e','r','t','y','u','i','o','p'],
    ['a','s','d','f','g','h','j','k','l'],
    ['⇧','z','x','c','v','b','n','m','⌫'],
    ['123','🎤',' ','⏎']
  ],
  digit:[
    ['1','2','3','4','5','6','7','8','9','0'],
    ['-','/',':',';','(',')','$','&','@','"'],
    ['#+=','.',',','?','!','\'','⇧','⌫'],
    ['ABC','🎤',' ','⏎']
  ]
};
function renderKB(){
  const kb=document.getElementById('keyboard');
  kb.innerHTML='';
  const lay=(layout==='digit'?LAYOUTS.digit:LAYOUTS.qwerty);
  
  lay.forEach(row=>{
    const r=document.createElement('div');
    r.className='row';
    
    row.forEach(k=>{
      const key=document.createElement('div');
      key.className='key';
      key.textContent=k;
      // 功能键标记
      if(['⇧','123','ABC','🎤','⏎','⌫','#+='].includes(k)){
        key.classList.add('fn');
      }
      // Shift键按下状态反馈
      if(k==='⇧'&&shift){
        key.style.background='var(--theme)';
      }
      key.onclick=()=>handleKey(k);
      r.appendChild(key);
    });
    kb.appendChild(r);
  });
}
function handleKey(k){
  const scr=document.getElementById('screen');
  switch(k){
    case '⇧':
      shift=!shift;
      renderKB();
      break;
    case '⌫':
      // 支持删除图片/文本混合内容
      const lastChild=scr.lastChild;
      if(lastChild?.nodeType===3&&lastChild.textContent.trim()===''){
        scr.removeChild(lastChild);
      }
      if(scr.lastChild){
        scr.removeChild(scr.lastChild);
      }
      break;
    case '⏎':
      scr.appendChild(document.createElement('br'));
      break;
    case '123':
      layout='digit';
      renderKB();
      break;
    case 'ABC':
      layout='qwerty';
      renderKB();
      break;
    case '🎤':
      status('语音接口预留');
      break;
    case ' ':
      scr.appendChild(document.createTextNode(' '));
      break;
    default:
      // 输入拉丁字母（处理Shift大小写）
      const l=shift?k.toUpperCase():k.toLowerCase();
      scr.appendChild(document.createTextNode(l));
      // 更新候选栏
      updateCand(l);
      // 自动取消Shift（模拟真实键盘）
      if(shift&&!['⇧','123','ABC'].includes(k)){
        shift=false;
        renderKB();
      }
      break;
  }
}
function updateCand(l){
  const box=document.getElementById('candidate');
  box.innerHTML='';
  const list=charTable[l.toLowerCase()]||[];
  
  if(!list.length){
    box.innerHTML='<em style="color:#666">无候选</em>';
    return;
  }
  
  list.forEach(it=>{
    const div=document.createElement('div');
    div.className='cand-char';
    
    const img=new Image();
    img.src=it.mirrorUrl||it.url;
    img.style.height='32px';
    img.onerror=()=>{
      div.innerHTML=`${it.url.split('/').pop().slice(0,2)}`;
      div.style.fontSize='12px';
      div.style.color='#ccc';
    };
    div.appendChild(img);

    div.onclick=()=>{
      const scr=document.getElementById('screen');
      const charContainer=document.createElement('span');
      charContainer.style.display='inline-block';
      charContainer.style.verticalAlign='middle';

      const im=new Image();
      im.src=it.mirrorUrl||it.url;
      im.style.height='1em';
      im.onerror=()=>{
        charContainer.textContent=`[${it.url.split('/').pop().slice(0,2)}]`;
        charContainer.style.color='#ccc';
      };
      charContainer.appendChild(im);
      scr.appendChild(charContainer);
      scr.appendChild(document.createTextNode(' '));
    };
    box.appendChild(div);
  });
}

/***************  IME绑定 & 状态提示  ****************/
function bindIME(){
  let timer;
  const scr=document.getElementById('screen');
  // 长按输入框打开手绘面板（移动端）
  scr.addEventListener('touchstart',e=>{
    timer=setTimeout(()=>{
      openDraw();
      e.preventDefault();
    },500);
  });
  scr.addEventListener('touchend',()=>clearTimeout(timer));
  // 禁止默认换行，统一逻辑
  scr.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.ctrlKey){
      e.preventDefault();
      scr.appendChild(document.createElement('br'));
    }
  });
}
function status(msg){
  const statusEl=document.getElementById('status');
  statusEl.textContent=msg;
  // 3秒后自动恢复"就绪"
  clearTimeout(statusEl.timer);
  statusEl.timer=setTimeout(()=>{
    statusEl.textContent='就绪';
  },3000);
}
</script>
</body>
</html>
